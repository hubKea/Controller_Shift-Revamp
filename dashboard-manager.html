<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<title>Manager Dashboard - Thinkers Afrika</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
      :root {
        --foreground-rgb: 13, 20, 27;
        --background-start-rgb: 243, 244, 246;
        --background-end-rgb: 243, 244, 246;
        --primary-color: #137fec;
        --secondary-color: #6b7280;
      }
      body {
        font-family: 'Inter', sans-serif;
        color: rgb(var(--foreground-rgb));
        background: linear-gradient(
          to bottom,
          transparent,
          rgb(var(--background-end-rgb))
        )
        rgb(var(--background-start-rgb));
      }
      .btn-primary-outline {
        @apply flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm transition-colors hover:bg-gray-50;
      }
      .badge {
        @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium;
      }
      .badge-green {
        @apply bg-green-100 text-green-800;
      }
      .badge-yellow {
        @apply bg-yellow-100 text-yellow-800;
      }
      .badge-red {
        @apply bg-red-100 text-red-800;
      }
    </style>
</head>
<body class="bg-gray-50">
<div class="flex min-h-screen w-full flex-col">
    <header class="sticky top-0 z-20 flex items-center justify-between whitespace-nowrap border-b border-neutral-200 bg-neutral-50 px-10 py-3">
<div class="flex items-center gap-6">
          <div class="flex items-center gap-3 text-neutral-900">
            <div class="h-8 w-8">
              <img src="ThinkersAfrica_Logo.jpeg" alt="ThinkersAfrica Logo" class="h-full w-full object-contain" />
            </div>
            <h1 class="text-xl font-bold">Thinkers Afrika</h1>
          </div>
            <nav class="flex items-center gap-6">
              <a class="text-sm font-bold text-primary-500 border-b-2 border-primary-500 pb-1" href="dashboard-manager.html">Dashboard</a>
            </nav>
</div>
<div class="flex items-center gap-4">
<div class="relative w-64">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"> search </span>
<input class="w-full rounded-lg border-gray-200 bg-gray-100 py-2 pl-10 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Search..." type="search"/>
</div>
<img alt="User avatar" class="h-10 w-10 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCoPYRdSfCqYfb4NhCX3jQXBm1Ez3hW2w94XONh8XGBLIiWXGflZi3xxusB-TgdTDgkm5sJaC85W2CpTTRuuqvUYUvFn5IngpJCCwODSLU6IpWckhykBhiiSabcN_X2A7VO0uFIb6sO1XiWEDm7ATx_viQtMC1Pc9sf3nqmgBumAO2a-_Q-g2DXEDHDLUQ5E-SNdTbdiZ1li-il8624rwBAXAfpet9zjFHb8Ckng2EldWzW-XVMg-hGdCiJ4ljJYEr9Ie5lFmVHkgEq"/>
</div>
</header>
    <main class="flex-1 bg-neutral-100 px-10 py-8">
<div class="mx-auto max-w-7xl">
<div class="mb-8 flex items-center justify-between">
<div>
<h1 class="text-3xl font-bold text-gray-900">Shift Reports</h1>
<p class="mt-1 text-sm text-gray-600">
                View and manage all shift reports submitted by controllers.
              </p>
</div>
<a href="report-form.html" class="btn-primary-outline">
<span class="material-symbols-outlined"> add </span>
<span>New Report</span>
</a>
</div>
<div class="mb-6 rounded-lg border border-gray-200 bg-white p-6">
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
<div>
<label class="block text-sm font-medium text-gray-700" for="date-range">Date Range</label>
<input class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="date-range" name="date-range" placeholder="Select Date Range" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700" for="controller">Controller</label>
<select class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="controller" name="controller">
<option>All Controllers</option>
<!-- Dynamic options will be populated here by JavaScript -->
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700" for="status">Status</label>
<select class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" id="status" name="status">
<option>All Statuses</option>
<option value="draft">Draft</option>
<option value="submitted">Pending Review</option>
<option value="under_review">Under Review</option>
<option value="approved">Approved</option>
<option value="rejected">Rejected</option>
</select>
</div>
<div class="self-end">
<button class="flex w-full items-center justify-center gap-2 rounded-lg border border-transparent bg-gray-800 px-4 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-gray-700" type="button">
<span class="material-symbols-outlined"> filter_list </span>
<span>Apply Filters</span>
</button>
</div>
</div>
</div>
<div class="overflow-hidden rounded-lg border border-gray-200 bg-white">
<div class="relative overflow-x-auto">
<table class="w-full text-left text-sm">
<thead class="sticky top-0 bg-gray-50 text-xs uppercase text-gray-700">
<tr>
<th class="px-6 py-3" scope="col">Date</th>
<th class="px-6 py-3" scope="col">Controller</th>
<th class="px-6 py-3" scope="col">Status</th>
<th class="px-6 py-3" scope="col">Approval History</th>
<th class="px-6 py-3 text-right" scope="col">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-gray-200">
<span class="material-symbols-outlined text-base"> download </span>
<span>Download PDF</span>
</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>

  <!-- Firebase Services -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="js/user-service.js"></script>
  <script type="module" src="js/enhanced-report-service.js"></script>
  <script type="module" src="js/data-model.js"></script>
  <script type="module" src="js/app.js"></script>

  <!-- Dashboard Manager Script -->
  <script type="module">
    import { auth } from './firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { userService } from './js/user-service.js';
    import { enhancedReportService } from './js/enhanced-report-service.js';

    class DashboardManager {
      constructor() {
        this.currentUser = null;
        this.userRole = null;
        this.reports = [];
        this.isInitialized = false;
        this.init();
      }

      async init() {
        try {
          // Set up authentication state listener as primary gatekeeper
          await this.setupAuthListener();
          
          // Initialize event listeners (these don't depend on auth state)
          this.initializeEventListeners();
          
        } catch (error) {
          console.error('Dashboard initialization error:', error);
          this.showError('Failed to initialize dashboard');
        }
      }

      async setupAuthListener() {
        console.log('üõ°Ô∏è Manager Dashboard: Using Authentication Guard...');
        
        try {
          // Use the central authentication guard - it will handle redirects
          const authResult = await userService.initializeAuthGuard();
          
          if (authResult.authenticated && authResult.role === 'manager') {
            console.log('‚úÖ Manager Dashboard: Authenticated manager user:', authResult.user.email);
            this.currentUser = authResult.user;
            this.userRole = authResult.role;
            this.userPermissions = authResult.permissions;
            
            // Update header with user info
            this.updateHeader();
            
            // Load all reports only after authentication is confirmed
            await this.loadAllReports();
            
            // Set up real-time updates
            await this.setupRealtimeUpdates();

            // Populate controller filter
            await this.populateControllerFilter();
          } else if (authResult.authenticated && authResult.role !== 'manager') {
            console.log('‚ö†Ô∏è Manager Dashboard: Non-manager user detected, auth guard will redirect');
            // Auth guard will handle the redirect
          } else {
            console.log('‚ùå Manager Dashboard: User not authenticated, auth guard will redirect');
            // Auth guard will handle the redirect
          }
        } catch (error) {
          console.error('‚ùå Manager Dashboard: Error during authentication:', error);
          this.showError('Failed to authenticate user');
        }
      }

      initializeEventListeners() {
        // Initialize filter functionality
        this.setupFilterListeners();
        
        console.log('Manager Dashboard: Event listeners initialized');
      }

      setupFilterListeners() {
        // Get filter elements
        const dateRangeInput = document.querySelector('input[placeholder="Select Date Range"]');
        const controllerSelect = document.querySelector('select#controller');
        const statusSelect = document.querySelector('select#status');
        const applyFiltersBtn = document.querySelector('button[type="button"]');

        // Add event listeners for real-time filtering
        if (dateRangeInput) {
          dateRangeInput.addEventListener('input', () => this.applyFilters());
        }

        if (controllerSelect) {
          controllerSelect.addEventListener('change', () => this.applyFilters());
        }

        if (statusSelect) {
          statusSelect.addEventListener('change', () => this.applyFilters());
        }

        // Apply filters button - look for the actual button with proper selector
        const actualApplyBtn = document.querySelector('button[type="button"]:not(#clearFiltersBtn)');
        if (actualApplyBtn && actualApplyBtn.textContent.includes('Apply Filters')) {
          actualApplyBtn.addEventListener('click', () => {
            console.log('üîç Apply Filters button clicked');
            this.applyFilters();
          });
        }

        // Clear filters functionality
        this.addClearFiltersButton();
      }

      addClearFiltersButton() {
        const filtersContainer = document.querySelector('.grid.grid-cols-1.gap-6.sm\\:grid-cols-2.lg\\:grid-cols-4');
        
        if (filtersContainer && !document.getElementById('clearFiltersBtn')) {
          const clearButtonDiv = document.createElement('div');
          clearButtonDiv.className = 'self-end';
          clearButtonDiv.innerHTML = `
            <button id="clearFiltersBtn" class="flex w-full items-center justify-center gap-2 rounded-lg border border-transparent bg-neutral-200 px-4 py-2 text-sm font-semibold text-neutral-800 shadow-sm transition-colors hover:bg-neutral-300" type="button">
              <span class="material-symbols-outlined">clear</span>
              <span>Clear Filters</span>
            </button>
          `;
          
          filtersContainer.appendChild(clearButtonDiv);
          
          // Add event listener for clear button
          document.getElementById('clearFiltersBtn').addEventListener('click', () => this.clearFilters());
        }
      }

      clearFilters() {
        // Clear all filter inputs
        const dateRangeInput = document.querySelector('input[placeholder="Select Date Range"]');
        const controllerSelect = document.querySelector('select#controller');
        const statusSelect = document.querySelector('select#status');

        if (dateRangeInput) dateRangeInput.value = '';
        if (controllerSelect) controllerSelect.selectedIndex = 0;
        if (statusSelect) statusSelect.selectedIndex = 0;

        console.log('Filters cleared, showing all reports');

        // Show all reports
        this.renderReports();
      }

      updateHeader() {
        // Update user avatar and name in header
        const userAvatar = document.querySelector('.h-10.w-10.rounded-full');
        const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0];
        
        if (userAvatar) {
          // Use profile photo if available, otherwise generate avatar
          const profilePhoto = this.currentUser.photoURL;
          if (profilePhoto) {
            userAvatar.style.backgroundImage = `url("${profilePhoto}")`;
          } else {
            userAvatar.style.backgroundImage = `url("https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=137fec&color=fff&size=40")`;
          }
        }
      }

      async loadAllReports() {
        try {
          this.showSkeletonLoading();
          this.showLoading('Loading all shift reports...');
          
          const result = await enhancedReportService.getAllReports({
            limit: 100 // Load last 100 reports for manager
          });

          if (result.success) {
            this.reports = result.reports;
            this.renderReports();
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error loading reports:', error);
          this.showError('Failed to load reports: ' + error.message);
          this.renderReports(); // Clear skeleton loading on error
        } finally {
          this.hideLoading();
        }
      }

      showSkeletonLoading() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;

        const skeletonRows = Array.from({ length: 6 }, (_, index) => `
          <tr class="animate-pulse">
            <td class="whitespace-nowrap px-6 py-4">
              <div class="h-4 bg-neutral-200 rounded w-20"></div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="h-4 bg-neutral-200 rounded w-32"></div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="h-6 bg-neutral-200 rounded-full w-20"></div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="h-4 bg-neutral-200 rounded w-40"></div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="flex justify-end gap-2">
                <div class="h-8 bg-neutral-200 rounded w-16"></div>
                <div class="h-8 bg-neutral-200 rounded w-20"></div>
                <div class="h-8 bg-neutral-200 rounded w-24"></div>
              </div>
            </td>
          </tr>
        `).join('');

        tbody.innerHTML = skeletonRows;
      }

      renderReports() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;

        // Clear existing rows
        tbody.innerHTML = '';

        if (this.reports.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-sm text-neutral-500">
                No reports found.
              </td>
            </tr>
          `;
          return;
        }

        // Render each report
        this.reports.forEach((report, index) => {
          const row = this.createReportRow(report, index);
          tbody.appendChild(row);
        });
      }

      createReportRow(report, index) {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'hover:bg-neutral-50' : 'bg-neutral-50 hover:bg-neutral-50';
        
        // Format date
        const reportDate = this.formatDate(this.getTimelineDate(report));
        
        // Get controller name(s) - Fixed to show controller1 and controller2
        const controllerName = this.getControllerName(report);
        
        // Create status badge
        const statusBadge = this.createStatusBadge(report.status);
        
        // Get approval history - NEW implementation
        const approvalHistory = this.getApprovalHistory(report);
        
        // Create action buttons
        const actionButtons = this.createActionButtons(report);

        row.innerHTML = `
          <td class="whitespace-nowrap px-6 py-4 text-sm text-neutral-600">${reportDate}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-neutral-800">${controllerName}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm">${statusBadge}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm text-neutral-600">${approvalHistory}</td>
          <td class="whitespace-nowrap px-6 py-4 text-sm">
            <div class="flex justify-end gap-2">${actionButtons}</div>
          </td>
        `;

        return row;
      }

      formatDate(dateInput) {
        try {
          let date;
          if (typeof dateInput === 'string') {
            date = new Date(dateInput);
          } else if (dateInput && dateInput.toDate) {
            // Firestore timestamp
            date = dateInput.toDate();
          } else {
            date = new Date(dateInput);
          }
          
          return date.toLocaleDateString('en-ZA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        } catch (error) {
          console.error('Date formatting error:', error);
          return 'N/A';
        }
      }

      getTimelineDate(report) {
        if (!report) return null;
        return report.shiftDate ||
          report.updatedAtClientIso ||
          report.createdAtClientIso ||
          (report.updatedAt && typeof report.updatedAt.toDate === 'function' ? report.updatedAt.toDate() : report.updatedAt) ||
          (report.createdAt && typeof report.createdAt.toDate === 'function' ? report.createdAt.toDate() : report.createdAt);
      }

      getControllerName(report) {
        // Get controller names from report data (prioritizing controller1 and controller2)
        const controller1 = report.controller1 || '';
        const controller2 = report.controller2 || '';
        
        const controllers = [controller1, controller2].filter(name => name && name.trim());
        
        if (controllers.length === 0) {
          // Fallback to other sources
          if (report.controllerName) {
            return report.controllerName;
          }
          
          if (report.personnelOnDuty && report.personnelOnDuty.length > 0) {
            const controller = report.personnelOnDuty.find(p => p.role === 'controller' || p.role === 'Controller');
            if (controller && controller.name) {
              return controller.name;
            }
          }
          
          return 'Unknown';
        } else if (controllers.length === 1) {
          return controllers[0];
        } else {
          return controllers.join(', ');
        }
      }

      createStatusBadge(status) {
        const statusConfig = {
          'draft': { class: 'bg-blue-50 text-blue-700 border border-blue-200', text: 'Draft' },
          'submitted': { class: 'bg-yellow-50 text-yellow-700 border border-yellow-200', text: 'Pending Review' },
          'under_review': { class: 'bg-orange-50 text-orange-700 border border-orange-200', text: 'Under Review' },
          'approved': { class: 'bg-green-50 text-green-700 border border-green-200', text: 'Approved' },
          'rejected': { class: 'bg-red-50 text-red-700 border border-red-200', text: 'Rejected' }
        };

        const config = statusConfig[status] || { class: 'bg-neutral-50 text-neutral-700 border border-neutral-200', text: status || 'Unknown' };
        
        return `<span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${config.class}">${config.text}</span>`;
      }

      getApprovalHistory(report) {
        const status = report.status;
        
        switch (status) {
          case 'approved':
            // Check if approval data exists
            if (report.approvedBy && report.approvedAt) {
              const approverName = report.approverName || report.approvedBy;
              const approvedDate = this.formatDate(report.approvedAt);
              return `Approved by: ${approverName} on ${approvedDate}`;
            } else if (report.approvals && report.approvals.length > 0) {
              // Check approvals array
              const approval = report.approvals.find(a => a.action === 'approved');
              if (approval) {
                const approverName = approval.approverName || approval.approverId;
                const approvedDate = this.formatDate(approval.timestamp);
                return `Approved by: ${approverName} on ${approvedDate}`;
              }
            }
            return 'Approved';
            
          case 'rejected':
            // Check if rejection data exists
            if (report.rejectedBy && report.rejectedAt) {
              const rejectorName = report.rejectorName || report.rejectedBy;
              const rejectedDate = this.formatDate(report.rejectedAt);
              return `Rejected by: ${rejectorName} on ${rejectedDate}`;
            } else if (report.approvals && report.approvals.length > 0) {
              // Check approvals array
              const rejection = report.approvals.find(a => a.action === 'rejected');
              if (rejection) {
                const rejectorName = rejection.approverName || rejection.approverId;
                const rejectedDate = this.formatDate(rejection.timestamp);
                return `Rejected by: ${rejectorName} on ${rejectedDate}`;
              }
            }
            return 'Rejected';
            
          case 'under_review':
          case 'submitted':
            // Get reviewers list
            if (report.reviewers && report.reviewers.length > 0) {
              const reviewerNames = report.reviewers.map(reviewer => {
                if (typeof reviewer === 'string') {
                  return reviewer;
                } else if (reviewer.name) {
                  return reviewer.name;
                } else if (reviewer.email) {
                  return reviewer.email.split('@')[0];
                }
                return 'Unknown Reviewer';
              });
              return `Awaiting approval from: ${reviewerNames.join(', ')}`;
            }
            return 'Awaiting approval';
            
          case 'draft':
            return 'Not yet submitted';
            
          default:
            return 'Unknown status';
        }
      }

      createActionButtons(report) {
        const buttons = [];
        const reportId = report.id;
        const status = report.status;

        switch (status) {
          case 'draft':
            buttons.push(`
              <a href="report-form.html?reportId=${reportId}" class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-1.5 text-xs font-medium text-neutral-700 transition-colors hover:bg-neutral-100">
                <span class="material-symbols-outlined text-base">visibility</span>
                <span>View</span>
              </a>
            `);
            break;

          case 'submitted':
          case 'under_review':
            buttons.push(`
              <a href="report-form.html?reportId=${reportId}" class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-1.5 text-xs font-medium text-neutral-700 transition-colors hover:bg-neutral-100">
                <span class="material-symbols-outlined text-base">visibility</span>
                <span>View</span>
              </a>
            `);
            buttons.push(`
              <button onclick="dashboardManager.approveReport('${reportId}')" class="flex items-center justify-center gap-2 rounded-[12px] border border-green-300 bg-green-50 px-3 py-1.5 text-xs font-medium text-green-700 transition-colors hover:bg-green-100">
                <span class="material-symbols-outlined text-base">check</span>
                <span>Approve</span>
              </button>
            `);
            buttons.push(`
              <button onclick="dashboardManager.rejectReport('${reportId}')" class="flex items-center justify-center gap-2 rounded-[12px] border border-red-300 bg-red-50 px-3 py-1.5 text-xs font-medium text-red-700 transition-colors hover:bg-red-100">
                <span class="material-symbols-outlined text-base">close</span>
                <span>Reject</span>
              </button>
            `);
            break;

          case 'approved':
            buttons.push(`
              <button onclick="dashboardManager.downloadPDF('${reportId}')" class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-1.5 text-xs font-medium text-neutral-700 transition-colors hover:bg-neutral-100">
                <span class="material-symbols-outlined text-base">download</span>
                <span>Download PDF</span>
              </button>
            `);
            break;

          case 'rejected':
            buttons.push(`
              <a href="report-form.html?reportId=${reportId}" class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-1.5 text-xs font-medium text-neutral-700 transition-colors hover:bg-neutral-100">
                <span class="material-symbols-outlined text-base">visibility</span>
                <span>View</span>
              </a>
            `);
            break;

          default:
            buttons.push(`
              <a href="report-form.html?reportId=${reportId}" class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-1.5 text-xs font-medium text-neutral-700 transition-colors hover:bg-neutral-100">
                <span class="material-symbols-outlined text-base">visibility</span>
                <span>View</span>
              </a>
            `);
        }

        return buttons.join('');
      }

      async approveReport(reportId) {
        try {
          this.showLoading('Approving report...');
          
          const result = await enhancedReportService.approveReport(reportId);
          
          if (result.success) {
            this.showSuccess('Report approved successfully!');
            // Reload reports to update status
            await this.loadAllReports();
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error approving report:', error);
          this.showError('Failed to approve report: ' + error.message);
        } finally {
          this.hideLoading();
        }
      }

      async rejectReport(reportId) {
        const reason = prompt('Please provide a reason for rejection:');
        if (!reason) return;

        try {
          this.showLoading('Rejecting report...');
          
          const result = await enhancedReportService.rejectReport(reportId, reason);
          
          if (result.success) {
            this.showSuccess('Report rejected successfully!');
            // Reload reports to update status
            await this.loadAllReports();
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error rejecting report:', error);
          this.showError('Failed to reject report: ' + error.message);
        } finally {
          this.hideLoading();
        }
      }

      async downloadPDF(reportId) {
        try {
          this.showLoading('Generating PDF...');
          
          // For now, we'll just show a message since PDF generation isn't implemented yet
          this.showSuccess('PDF generation will be implemented in the next phase');
          
          // TODO: Implement actual PDF generation
          // const result = await enhancedReportService.generatePDF(reportId);
          
        } catch (error) {
          console.error('Error downloading PDF:', error);
          this.showError('Failed to generate PDF: ' + error.message);
        } finally {
          this.hideLoading();
        }
      }

      async setupRealtimeUpdates() {
        try {
          console.log('Setting up real-time updates for manager dashboard...');
          
          // Set up real-time listener for all reports
          const { collection, onSnapshot, orderBy, query } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
          const { db } = await import('./firebase-config.js');
          
          const reportsRef = collection(db, 'shiftReports');
          const q = query(reportsRef, orderBy('updatedAtServer', 'desc'));
          
          this.unsubscribeRealtimeUpdates = onSnapshot(q, (snapshot) => {
            console.log('Real-time update received for manager dashboard');
            
            const reports = [];
            snapshot.forEach((doc) => {
              reports.push({ id: doc.id, ...doc.data() });
            });
            
            this.reports = reports;
            this.renderReports();
          }, (error) => {
            console.error('Real-time listener error:', error);
            this.showError('Real-time updates failed: ' + error.message);
          });
          
        } catch (error) {
          console.error('Error setting up real-time updates:', error);
        }
      }

      async populateControllerFilter() {
        try {
          console.log('üìã Populating controller filter...');
          
          // Import Firestore functions
          const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js');
          const { db } = await import('./firebase-config.js');
          
          // Get all users from Firestore
          const usersRef = collection(db, 'users');
          const usersSnapshot = await getDocs(usersRef);
          
          const controllers = [];
          usersSnapshot.forEach((doc) => {
            const userData = doc.data();
            if (userData.role === 'controller' || userData.role === 'manager') {
              controllers.push({
                name: userData.displayName || userData.email.split('@')[0],
                email: userData.email
              });
            }
          });
          
          // Get the controller select element
          const controllerSelect = document.querySelector('select#controller');
          if (controllerSelect) {
            // Clear existing options except "All Controllers"
            controllerSelect.innerHTML = '<option value="">All Controllers</option>';
            
            // Add controller options
            controllers.forEach(controller => {
              const option = document.createElement('option');
              option.value = controller.name.toLowerCase();
              option.textContent = controller.name;
              controllerSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Added ${controllers.length} controllers to filter`);
          }
        } catch (error) {
          console.error('‚ùå Error populating controller filter:', error);
        }
      }

      applyFilters() {
        try {
          // Get filter values
          const dateRangeInput = document.querySelector('input[placeholder="Select Date Range"]');
          const controllerSelect = document.querySelector('select#controller');
          const statusSelect = document.querySelector('select#status');

          const dateFilter = dateRangeInput ? dateRangeInput.value.toLowerCase() : '';
          const controllerFilter = controllerSelect ? controllerSelect.value.toLowerCase() : '';
          const statusFilter = statusSelect ? statusSelect.value.toLowerCase() : '';

          // Filter reports
          const filteredReports = this.reports.filter(report => {
            const reportDate = this.formatDate(this.getTimelineDate(report)).toLowerCase();
            const controllerName = this.getControllerName(report).toLowerCase();
            const status = (report.status || '').toLowerCase();

            // Apply filters (empty filter means show all)
            const dateMatch = !dateFilter || reportDate.includes(dateFilter);
            const controllerMatch = !controllerFilter || controllerFilter === 'all controllers' || controllerName.includes(controllerFilter);
            const statusMatch = !statusFilter || statusFilter === 'all statuses' || status.includes(statusFilter);

            return dateMatch && controllerMatch && statusMatch;
          });

          console.log(`Applied filters: ${filteredReports.length} of ${this.reports.length} reports match`);

          // Update display
          this.renderFilteredReports(filteredReports);
        } catch (error) {
          console.error('Error applying filters:', error);
          this.renderReports(); // Fallback to showing all reports
        }
      }

      renderFilteredReports(reports) {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;

        // Clear existing rows
        tbody.innerHTML = '';

        if (reports.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-sm text-neutral-500">
                No reports match your filters.
              </td>
            </tr>
          `;
          return;
        }

        // Render filtered reports
        reports.forEach((report, index) => {
          const row = this.createReportRow(report, index);
          tbody.appendChild(row);
        });
      }

      showLoading(message = 'Loading...') {
        // Create or update loading message
        let loadingEl = document.getElementById('loadingMessage');
        if (!loadingEl) {
          loadingEl = document.createElement('div');
          loadingEl.id = 'loadingMessage';
          loadingEl.className = 'fixed top-4 right-4 z-50 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg';
          document.body.appendChild(loadingEl);
        }
        loadingEl.textContent = message;
        loadingEl.style.display = 'block';
      }

      hideLoading() {
        const loadingEl = document.getElementById('loadingMessage');
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
      }

      showSuccess(message) {
        this.showMessage(message, 'success');
      }

      showError(message) {
        this.showMessage(message, 'error');
      }

      showMessage(message, type) {
        const colors = {
          success: 'bg-green-500',
          error: 'bg-red-500',
          info: 'bg-blue-500'
        };

        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-4 right-4 z-50 ${colors[type] || colors.info} text-white px-4 py-2 rounded-lg shadow-lg`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        // Auto-hide after 5 seconds
        setTimeout(() => {
          if (messageEl.parentNode) {
            messageEl.parentNode.removeChild(messageEl);
          }
        }, 5000);
      }
    }

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      window.dashboardManager = new DashboardManager();
    });
  </script>
</body></html>
