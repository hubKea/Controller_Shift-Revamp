<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link
      as="style"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900"
      onload="this.rel='stylesheet'"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles/tailwind.css" />
    <link rel="stylesheet" href="styles/a11y.css" />
    <title>Controller Shift Report - Thinkers Afrika</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  </head>
  <body class="bg-neutral-50 text-neutral-800" data-active-nav="dashboard">
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:fixed focus:z-50 focus:top-2 focus:left-2 focus:bg-white focus:text-black focus:px-3 focus:py-2 focus:rounded"
    >
      Skip to main content
    </a>
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
      <header
        role="banner"
        class="sticky top-0 z-20 flex items-center justify-between whitespace-nowrap border-b border-neutral-200 bg-neutral-50 px-10 py-3"
      >
        <div class="flex items-center gap-8">
          <div class="flex items-center gap-3 text-neutral-900">
            <div class="h-8 w-8">
              <img
                src="ThinkersAfrica_Logo.jpeg"
                alt="ThinkersAfrica Logo"
                class="h-full w-full object-contain"
              />
            </div>
            <h1 class="text-xl font-bold">Thinkers Afrika</h1>
          </div>
          <nav class="flex items-center gap-6" role="navigation" aria-label="Primary navigation">
            <a
              data-dashboard-link="dashboard"
              data-nav="dashboard"
              class="text-sm font-bold text-primary-500 border-b-2 border-primary-500 pb-1"
              href="#"
              >Dashboard</a
            >
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <div class="relative">
            <button
              id="messagesButton"
              type="button"
              class="relative flex h-10 w-10 items-center justify-center rounded-full text-neutral-500 transition-colors hover:bg-neutral-100 hover:text-neutral-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2"
              aria-label="Messages"
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="messages-menu"
            >
              <span class="material-symbols-outlined" aria-hidden="true">chat</span>
              <span
                id="messagesUnreadBadge"
                class="pointer-events-none absolute -top-1.5 -right-1.5 hidden min-w-[1.5rem] rounded-full bg-red-500 px-1.5 py-0.5 text-center text-xs font-semibold leading-none text-white"
                aria-live="polite"
                aria-atomic="true"
              ></span>
            </button>
            <div
              id="messages-menu"
              class="absolute right-full z-30 mr-3 hidden w-72 md:right-0 md:mr-0 md:mt-3"
              hidden
            ></div>
          </div>
          <div class="relative">
            <button
              id="btn-notifications"
              type="button"
              class="relative flex h-10 w-10 items-center justify-center rounded-full text-neutral-500 transition-colors hover:bg-neutral-100 hover:text-neutral-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2"
              aria-label="Notifications"
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="notifications-menu"
            >
              <span class="material-symbols-outlined" aria-hidden="true">notifications</span>
              <span
                id="notifications-unread-badge"
                class="pointer-events-none absolute -top-1.5 -right-1.5 hidden min-w-[1.5rem] rounded-full bg-red-500 px-1.5 py-0.5 text-center text-xs font-semibold leading-none text-white"
                aria-live="polite"
                aria-atomic="true"
              ></span>
            </button>
            <div
              id="notifications-menu"
              class="absolute right-0 z-30 mt-3 hidden w-80"
              hidden
            ></div>
          </div>
          <div
            class="h-10 w-10 rounded-full bg-cover bg-center"
            style="
              background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuD28RCrVpF_Mrb_Y6VHsI2u1sA9eBWp8y9HSHNYJhfCxci4Kf0pJ5gaWTdr3ZlOEwoi1SxQ3sxgCCqLC0ZM-LLM_v6MiXWJvsE-hTkq3A-4wrskcypnIufVE_uORyF3J0rSt_YT0JcM1GVFtqHnL0-t5h0m5ekjuyhHnu_qP0pPpVL76uOxU5ARZw8j9OPLrGBEA658oPxOweg5bQkfF2IL9n0AY1vJlDe35WqqH8avF3j00z7-LqcMGVXLkbLmzZR4gNhVm2IqEK_O');
            "
          ></div>
        </div>
      </header>

      <main id="main" role="main" class="flex-1 bg-neutral-100 px-10 py-8">
        <div class="mx-auto max-w-7xl">
          <!-- Message Box -->
          <div id="message-box" class="hidden"></div>

          <!-- Page Header -->
          <div class="mb-8 flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-neutral-900">Controller Shift Report</h1>
              <p class="mt-1 text-sm text-neutral-600">
                Create and submit your shift report for review and approval.
              </p>
            </div>
            <a
              id="backToDashboardLink"
              data-dashboard-link="back"
              href="#"
              class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
            >
              <span class="material-symbols-outlined">arrow_back</span>
              <span>Back to Dashboard</span>
            </a>
          </div>

          <!-- Report Form -->
          <section class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
            <form id="reportForm" class="space-y-8">
              <!-- Basic Information -->
              <section class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                  <input
                    id="reportDate"
                    type="date"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Shift</label>
                  <select
                    id="shiftType"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  >
                    <option value="">Select Shift</option>
                    <option>Day Shift (06:00 - 18:00)</option>
                    <option>Night Shift (18:00 - 06:00)</option>
                  </select>
                </div>

                <div class="col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >On-duty Controllers</label
                  >
                  <div class="grid md:grid-cols-2 gap-4">
                    <select
                      id="controller1"
                      class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                      required
                    >
                      <option value="">Select Controller</option>
                    </select>
                    <select
                      id="controller2"
                      class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                      required
                    >
                      <option value="">Select Controller</option>
                    </select>
                  </div>
                </div>
              </section>

              <!-- Logistics Information -->
              <section class="grid md:grid-cols-3 gap-6">
                <div class="grid md:grid-cols-2 gap-4 col-span-2">
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2"
                      >Loading Point</label
                    >
                    <input
                      id="startingDestination"
                      type="text"
                      class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2"
                      >Offloading Point</label
                    >
                    <input
                      id="endingDestination"
                      type="text"
                      class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                      required
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Total Trucks Scheduled</label
                  >
                  <input
                    id="totalTrucks"
                    type="number"
                    min="0"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Pending Deliveries</label
                  >
                  <input
                    id="pendingDeliveries"
                    type="number"
                    min="0"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Total Loads Dispatched</label
                  >
                  <input
                    id="totalLoads"
                    type="number"
                    min="0"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Total Loads Delivered</label
                  >
                  <input
                    id="loadsDelivered"
                    type="number"
                    min="0"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-gray-50"
                    required
                    readonly
                  />
                </div>

                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Overall Shift Performance</label
                  >
                  <select
                    id="shiftPerformance"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  >
                    <option value="">Select Performance</option>
                    <option>Smooth</option>
                    <option>Moderate Delays</option>
                    <option>Challenging</option>
                  </select>
                </div>

                <div class="md:col-span-3">
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Key Highlights / Observations</label
                  >
                  <textarea
                    id="keyHighlights"
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  ></textarea>
                </div>
              </section>

              <!-- Truck Updates -->
              <section class="bg-gray-50 p-6 rounded-2xl">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Truck Updates & Logistics Flow</h3>
                <div id="truckUpdatesContainer" class="space-y-3"></div>
                <div class="flex space-x-3 mt-4">
                  <button
                    id="addTruckUpdate"
                    type="button"
                    class="flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                  >
                    <span class="material-symbols-outlined text-base">add</span>
                    <span>Add Update</span>
                  </button>
                </div>
              </section>

              <!-- Incidents -->
              <section class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-3 bg-red-50 p-6 rounded-2xl">
                  <h3 class="text-xl font-bold text-gray-900 mb-4">Breakdowns Reported</h3>
                  <div id="breakdownsContainer" class="space-y-4"></div>
                  <button
                    id="addBreakdown"
                    type="button"
                    class="mt-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                  >
                    <span class="material-symbols-outlined text-base">add</span>
                    <span>Add Breakdown</span>
                  </button>
                </div>

                <div class="md:col-span-3 bg-yellow-50 p-6 rounded-2xl">
                  <h3 class="text-xl font-bold text-gray-900 mb-4">
                    Documentation of Phone Calls for Non-Adherence
                  </h3>
                  <div id="phoneCallsContainer" class="space-y-4"></div>
                  <button
                    id="addPhoneCall"
                    type="button"
                    class="mt-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                  >
                    <span class="material-symbols-outlined text-base">add</span>
                    <span>Add Phone Call</span>
                  </button>
                </div>

                <div class="md:col-span-3 bg-purple-50 p-6 rounded-2xl">
                  <h3 class="text-xl font-bold text-gray-900 mb-4">Investigation Findings</h3>
                  <div id="investigationsContainer" class="space-y-4"></div>
                  <button
                    id="addInvestigation"
                    type="button"
                    class="mt-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                  >
                    <span class="material-symbols-outlined text-base">add</span>
                    <span>Add Investigation</span>
                  </button>
                </div>
              </section>

              <!-- Communication Log -->
              <section class="bg-green-50 p-6 rounded-2xl">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Communication Log</h3>
                <div id="communicationLogContainer" class="space-y-4"></div>
                <button
                  id="addCommunication"
                  type="button"
                  class="mt-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                >
                  <span class="material-symbols-outlined text-base">add</span>
                  <span>Add Communication</span>
                </button>
              </section>

              <!-- Handover & Declaration -->
              <section class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Outstanding Issues / Follow-ups</label
                  >
                  <textarea
                    id="outstandingIssues"
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  ></textarea>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Key Information for Incoming Shift</label
                  >
                  <textarea
                    id="incomingInfo"
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                    required
                  ></textarea>
                </div>
                <div class="md:col-span-2 bg-blue-50 p-6 rounded-2xl">
                  <div class="flex items-start mb-6">
                    <input
                      id="declarationCheckbox"
                      type="checkbox"
                      class="mt-1 w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                      required
                    />
                    <label class="ml-3 text-gray-700"
                      ><strong>Declaration:</strong> We certify that the information contained in
                      this shift report is accurate and complete to the best of our
                      knowledge.</label
                    >
                  </div>
                  <div>
                    <label class="block text-lg font-bold text-gray-900 mb-4"
                      >Report Reviewers</label
                    >
                    <div class="grid md:grid-cols-2 gap-4">
                      <select
                        id="reviewer1"
                        class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                        required
                      >
                        <option value="">Select Primary Reviewer</option>
                        <option value="keamogetswe@thinkersafrika.co.za">
                          Keamogetswe Maripane
                        </option>
                        <option value="sipho@thinkersafrika.co.za">Sipho Mahlinza</option>
                        <option value="kabelo@thinkersafrika.co.za">Kabelo Tshabalala</option>
                        <option value="gontle@thinkersafrika.co.za">Gontle Ditibane</option>
                        <option value="matshidiso@thinkersafrika.co.za">Matshidiso Maake</option>
                        <option value="john@thinkersafrika.co.za">John Macharaga</option>
                        <option value="vincent@thinkersafrika.co.za">
                          Vincent Mogashoa (Manager)
                        </option>
                      </select>
                      <select
                        id="reviewer2"
                        class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                      >
                        <option value="">Select Secondary Reviewer (Optional)</option>
                        <option value="keamogetswe@thinkersafrika.co.za">
                          Keamogetswe Maripane
                        </option>
                        <option value="sipho@thinkersafrika.co.za">Sipho Mahlinza</option>
                        <option value="kabelo@thinkersafrika.co.za">Kabelo Tshabalala</option>
                        <option value="gontle@thinkersafrika.co.za">Gontle Ditibane</option>
                        <option value="matshidiso@thinkersafrika.co.za">Matshidiso Maake</option>
                        <option value="john@thinkersafrika.co.za">John Macharaga</option>
                        <option value="vincent@thinkersafrika.co.za">
                          Vincent Mogashoa (Manager)
                        </option>
                      </select>
                    </div>
                  </div>
                </div>
              </section>

              <!-- Action Buttons -->
              <div class="text-center pt-8 space-y-4">
                <button
                  id="generatePdfBtn"
                  type="button"
                  class="w-full md:w-1/3 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-6 py-3 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                  style="display: none"
                >
                  <span class="material-symbols-outlined text-base">download</span>
                  <span>Generate PDF Report</span>
                </button>
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                  <button
                    id="saveAsDraftBtn"
                    type="button"
                    class="w-full md:w-1/3 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-6 py-3 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
                    disabled
                  >
                    <span class="material-symbols-outlined text-base">save</span>
                    <span>Save as Draft</span>
                  </button>
                  <button
                    id="sendForReviewBtn"
                    type="button"
                    class="w-full md:w-1/3 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-800 bg-transparent px-6 py-3 text-sm font-semibold text-neutral-800 transition-colors hover:bg-neutral-800 hover:text-white"
                    disabled
                  >
                    <span class="material-symbols-outlined text-base">send</span>
                    <span>Send for Review</span>
                  </button>
                </div>
              </div>
            </form>
          </section>
        </div>
      </main>
    </div>

    <!-- Templates -->
    <template id="truckUpdateTemplate">
      <div class="flex items-start space-x-3">
        <input
          type="text"
          class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
          placeholder="(HH:MM) - Status"
        />
        <button
          class="remove-btn flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-3 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
        >
          <span class="material-symbols-outlined text-base">remove</span>
        </button>
      </div>
    </template>

    <template id="breakdownTemplate">
      <div
        class="grid md:grid-cols-4 gap-3 p-4 border border-gray-200 rounded-xl items-end bg-white shadow-sm"
      >
        <input
          placeholder="Truck Reg No."
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Time Reported (HH:MM)"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Issue"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Status/Resolution"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <button
          class="remove-btn md:col-span-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
        >
          <span class="material-symbols-outlined text-base">remove</span>
          <span>Remove</span>
        </button>
      </div>
    </template>

    <template id="phoneCallTemplate">
      <div
        class="grid md:grid-cols-4 gap-3 p-4 border border-gray-200 rounded-xl items-end bg-white shadow-sm"
      >
        <input
          placeholder="Driver/Truck Reg No."
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Rule Violated"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Time of Call (HH:MM)"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Summary"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <button
          class="remove-btn md:col-span-4 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
        >
          <span class="material-symbols-outlined text-base">remove</span>
          <span>Remove</span>
        </button>
      </div>
    </template>

    <template id="investigationTemplate">
      <div
        class="grid md:grid-cols-5 gap-3 p-4 border border-gray-200 rounded-xl items-end bg-white shadow-sm"
      >
        <input
          placeholder="Truck Reg No."
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Issue Identified"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Time/Location"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Findings"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Action Taken"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <button
          class="remove-btn md:col-span-5 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
        >
          <span class="material-symbols-outlined text-base">remove</span>
          <span>Remove</span>
        </button>
      </div>
    </template>

    <template id="communicationTemplate">
      <div
        class="grid md:grid-cols-3 gap-3 p-4 border border-gray-200 rounded-xl items-end bg-white shadow-sm"
      >
        <input
          placeholder="Time (HH:MM)"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Recipient"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <input
          placeholder="Subject/Purpose"
          class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
        />
        <button
          class="remove-btn md:col-span-3 flex items-center justify-center gap-2 rounded-[12px] border border-neutral-300 bg-white px-4 py-2 text-sm font-semibold text-neutral-700 transition-colors hover:bg-neutral-100"
        >
          <span class="material-symbols-outlined text-base">remove</span>
          <span>Remove</span>
        </button>
      </div>
    </template>

    <!-- Firebase Services -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="js/user-service.js"></script>
    <script type="module" src="js/enhanced-report-service.js"></script>
    <script type="module" src="js/data-model.js"></script>
    <script type="module" src="js/app.js"></script>
    <script type="module">
      // Firebase and utilities imports
      import { userService } from './js/user-service.js';
      import { enhancedReportService } from './js/enhanced-report-service.js';
      import { nowIso } from './js/utils.js'; // Timestamp utility for client-side ISO strings
      import { generatePdf } from './js/pdf-service.js';
      import { ROLE_REVIEWER } from './js/constants.js';

      const controllerSelects = ['controller1', 'controller2'].map((id) =>
        document.getElementById(id)
      );
      let controllerOptionsLoaded = false;
      let controllerOptionsLoading = false;

      const populateControllerSelect = (select, items) => {
        if (!select) return;
        const preferredValue =
          select.dataset.preferredEmail || select.dataset.preferredUid || select.value;

        select.innerHTML = '';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select Controller';
        select.appendChild(placeholder);

        items.forEach((item) => {
          if (!item?.email) return;
          const option = document.createElement('option');
          option.value = item.email;
          option.textContent = item.displayName || item.email;
          option.dataset.email = item.email;
          option.dataset.uid = item.uid || '';
          option.dataset.role = item.role || '';
          select.appendChild(option);
        });

        if (preferredValue) {
          select.value = preferredValue;
        }

        if (typeof applyPreferredSelectValue === 'function') {
          applyPreferredSelectValue(select);
        }
      };

      const loadControllerOptions = async () => {
        if (controllerOptionsLoaded || controllerOptionsLoading) return;
        controllerOptionsLoading = true;

        try {
          const current =
            typeof userService.getCurrentUser === 'function' ? userService.getCurrentUser() : null;
          if (!current?.isAuthenticated) {
            return;
          }

          const functionsModule = await import(
            'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js'
          );
          const functions = functionsModule.getFunctions();
          const listForAssign = functionsModule.httpsCallable(functions, 'users-listForAssign');
          const response = await listForAssign({ roles: ['controller'] });
          const items = Array.isArray(response?.data?.items) ? response.data.items : [];

          items.sort((a, b) => {
            const aName = (a.displayName || a.email || '').toLowerCase();
            const bName = (b.displayName || b.email || '').toLowerCase();
            return aName.localeCompare(bName);
          });

          controllerSelects.forEach((select) => populateControllerSelect(select, items));
          controllerOptionsLoaded = true;
        } catch (error) {
          console.error('[ReportForm] Failed to load controller options:', error);
        } finally {
          controllerOptionsLoading = false;
        }
      };

      const previousAuthHandler =
        typeof userService.onAuthStateChange === 'function'
          ? userService.onAuthStateChange.bind(userService)
          : null;

      userService.onAuthStateChange = (user, role, permissions) => {
        if (previousAuthHandler) {
          try {
            previousAuthHandler(user, role, permissions);
          } catch (error) {
            console.error('[ReportForm] Previous auth handler failed', error);
          }
        }

        if (user && user.uid) {
          loadControllerOptions();
        }
      };

      const currentSnapshot =
        typeof userService.getCurrentUser === 'function' ? userService.getCurrentUser() : null;
      if (currentSnapshot?.isAuthenticated) {
        loadControllerOptions();
      }

      let currentReportId = null;
      let currentReportData = null;
      const generatePdfBtn = document.getElementById('generatePdfBtn');

      function rememberSelectPreference(select, { uid = '', email = '', label = '' } = {}) {
        if (!select) return;
        select.dataset.preferredUid = uid;
        select.dataset.preferredEmail = email ? email.toLowerCase() : '';
        select.dataset.preferredLabel = label ? label.toLowerCase() : '';
      }

      function applyPreferredSelectValue(select) {
        if (!select) return;

        const preferredUid = select.dataset.preferredUid;
        if (preferredUid) {
          select.value = preferredUid;
          if (select.value === preferredUid) return;
        }

        const preferredEmail = select.dataset.preferredEmail;
        if (preferredEmail) {
          const matchByEmail = Array.from(select.options).find(
            (option) => (option.dataset.email || '').toLowerCase() === preferredEmail
          );
          if (matchByEmail) {
            select.value = matchByEmail.value;
            return;
          }
        }

        const preferredLabel = select.dataset.preferredLabel;
        if (preferredLabel) {
          const matchByLabel = Array.from(select.options).find(
            (option) => option.text.trim().toLowerCase() === preferredLabel
          );
          if (matchByLabel) {
            select.value = matchByLabel.value;
            return;
          }
        }

        select.value = '';
      }

      function ensureSelectPreferenceListener(select) {
        if (!select || select.dataset.preferenceListenerAttached === 'true') return;
        select.addEventListener('change', () => {
          const selectedOption = select.selectedOptions && select.selectedOptions[0];
          rememberSelectPreference(select, {
            uid: select.value || '',
            email: selectedOption?.dataset.email || '',
            label: selectedOption ? selectedOption.text.trim() : '',
          });
        });
        select.dataset.preferenceListenerAttached = 'true';
      }

      function getSelectDetailsById(id) {
        const select = document.getElementById(id);
        const selectedOption = select?.selectedOptions && select.selectedOptions[0];
        const uid = select?.value || '';
        const label = selectedOption ? selectedOption.text.trim() : '';
        const email = selectedOption?.dataset.email?.trim() || '';
        return { uid, label, email };
      }

      function setSelectPreference(id, preference = {}) {
        const select = document.getElementById(id);
        if (!select) return;
        rememberSelectPreference(select, preference);
        applyPreferredSelectValue(select);
      }

      // Form handling service
      class FormService {
        constructor() {
          this.form = document.getElementById('reportForm');
          this.containers = {
            truckUpdates: document.getElementById('truckUpdatesContainer'),
            breakdowns: document.getElementById('breakdownsContainer'),
            phoneCalls: document.getElementById('phoneCallsContainer'),
            investigations: document.getElementById('investigationsContainer'),
            communicationLog: document.getElementById('communicationLogContainer'),
          };
          this.templates = {
            truckUpdate: document.getElementById('truckUpdateTemplate'),
            breakdown: document.getElementById('breakdownTemplate'),
            phoneCall: document.getElementById('phoneCallTemplate'),
            investigation: document.getElementById('investigationTemplate'),
            communication: document.getElementById('communicationTemplate'),
          };
          this.initDefaults();
          this.setupEventListeners();
        }

        initDefaults() {
          // Add one default truck update
          if (this.containers.truckUpdates.children.length === 0) {
            this.addTruckUpdate();
          }
        }

        setupEventListeners() {
          // Add buttons
          document
            .getElementById('addTruckUpdate')
            .addEventListener('click', () => this.addTruckUpdate());
          document
            .getElementById('addBreakdown')
            .addEventListener('click', () => this.addBreakdown());
          document
            .getElementById('addPhoneCall')
            .addEventListener('click', () => this.addPhoneCall());
          document
            .getElementById('addInvestigation')
            .addEventListener('click', () => this.addInvestigation());
          document
            .getElementById('addCommunication')
            .addEventListener('click', () => this.addCommunication());

          // Auto-calculation for loads delivered
          const totalLoadsInput = document.getElementById('totalLoads');
          const pendingDeliveriesInput = document.getElementById('pendingDeliveries');
          const loadsDeliveredInput = document.getElementById('loadsDelivered');

          function calculateLoadsDelivered() {
            const totalLoads = parseInt(totalLoadsInput.value, 10) || 0;
            const pendingDeliveries = parseInt(pendingDeliveriesInput.value, 10) || 0;
            loadsDeliveredInput.value = totalLoads - pendingDeliveries;
          }

          totalLoadsInput.addEventListener('input', calculateLoadsDelivered);
          pendingDeliveriesInput.addEventListener('input', calculateLoadsDelivered);

          // Make loadsDelivered readonly
          loadsDeliveredInput.readOnly = true;
        }

        addTruckUpdate(text = '') {
          const node = this.templates.truckUpdate.content.cloneNode(true);
          const input = node.querySelector('input');
          input.value = text;
          const btn = node.querySelector('.remove-btn');
          btn.addEventListener('click', (e) => e.target.closest('div').remove());
          this.containers.truckUpdates.appendChild(node);
        }

        addBreakdown(item = {}) {
          const node = this.templates.breakdown.content.cloneNode(true);
          const inputs = node.querySelectorAll('input');
          inputs[0].value = item.truckRegNo || '';
          inputs[1].value = item.timeReported || '';
          inputs[2].value = item.issue || '';
          inputs[3].value = item.status || '';
          node
            .querySelector('.remove-btn')
            .addEventListener('click', (e) => e.target.closest('.grid').remove());
          this.containers.breakdowns.appendChild(node);
        }

        addPhoneCall(item = {}) {
          const node = this.templates.phoneCall.content.cloneNode(true);
          const inputs = node.querySelectorAll('input');
          inputs[0].value = item.driverTruckRegNo || '';
          inputs[1].value = item.ruleViolated || '';
          inputs[2].value = item.timeOfCall || '';
          inputs[3].value = item.summary || '';
          node
            .querySelector('.remove-btn')
            .addEventListener('click', (e) => e.target.closest('.grid').remove());
          this.containers.phoneCalls.appendChild(node);
        }

        addInvestigation(item = {}) {
          const node = this.templates.investigation.content.cloneNode(true);
          const inputs = node.querySelectorAll('input');
          inputs[0].value = item.truckRegNo || '';
          inputs[1].value = item.issueIdentified || '';
          inputs[2].value = item.timeLocation || '';
          inputs[3].value = item.findings || '';
          inputs[4].value = item.actionTaken || '';
          node
            .querySelector('.remove-btn')
            .addEventListener('click', (e) => e.target.closest('.grid').remove());
          this.containers.investigations.appendChild(node);
        }

        addCommunication(item = {}) {
          const node = this.templates.communication.content.cloneNode(true);
          const inputs = node.querySelectorAll('input');
          inputs[0].value = item.time || '';
          inputs[1].value = item.recipient || '';
          inputs[2].value = item.subject || '';
          node
            .querySelector('.remove-btn')
            .addEventListener('click', (e) => e.target.closest('.grid').remove());
          this.containers.communicationLog.appendChild(node);
        }

        /*
         * ## Audit 2025-10-19 â€“ Controller roster validation
         * - Persist controller UIDs/emails alongside names so downstream services (security rules, review queues, notifications) operate on the same identifiers.
         * - This mirrors the QA verification run against the dynamic dropdown callable and prevents duplicate controller assignments.
         */
        getFormData() {
          const getVal = (id) => document.getElementById(id)?.value || '';

          const controller1Details = getSelectDetailsById('controller1');
          const controller2Details = getSelectDetailsById('controller2');
          const reviewer1Details = getSelectDetailsById('reviewer1');
          const reviewer2Details = getSelectDetailsById('reviewer2');

          rememberSelectPreference(document.getElementById('controller1'), controller1Details);
          rememberSelectPreference(document.getElementById('controller2'), controller2Details);
          rememberSelectPreference(document.getElementById('reviewer1'), reviewer1Details);
          rememberSelectPreference(document.getElementById('reviewer2'), reviewer2Details);

          const truckUpdates = Array.from(this.containers.truckUpdates.querySelectorAll('input'))
            .map((i) => i.value.trim())
            .filter((v) => v);

          const breakdowns = Array.from(this.containers.breakdowns.querySelectorAll('.grid'))
            .map((div) => Array.from(div.querySelectorAll('input')).map((i) => i.value.trim()))
            .filter((arr) => arr.some((v) => v))
            .map((arr) => ({
              truckRegNo: arr[0],
              timeReported: arr[1],
              issue: arr[2],
              status: arr[3],
            }));

          const phoneCalls = Array.from(this.containers.phoneCalls.querySelectorAll('.grid'))
            .map((div) => Array.from(div.querySelectorAll('input')).map((i) => i.value.trim()))
            .filter((arr) => arr.some((v) => v))
            .map((arr) => ({
              driverTruckRegNo: arr[0],
              ruleViolated: arr[1],
              timeOfCall: arr[2],
              summary: arr[3],
            }));

          const investigations = Array.from(
            this.containers.investigations.querySelectorAll('.grid')
          )
            .map((div) => Array.from(div.querySelectorAll('input')).map((i) => i.value.trim()))
            .filter((arr) => arr.some((v) => v))
            .map((arr) => ({
              truckRegNo: arr[0],
              issueIdentified: arr[1],
              timeLocation: arr[2],
              findings: arr[3],
              actionTaken: arr[4],
            }));

          const communicationLog = Array.from(
            this.containers.communicationLog.querySelectorAll('.grid')
          )
            .map((div) => Array.from(div.querySelectorAll('input')).map((i) => i.value.trim()))
            .filter((arr) => arr.some((v) => v))
            .map((arr) => ({ time: arr[0], recipient: arr[1], subject: arr[2] }));

          return {
            reportDate: getVal('reportDate'),
            shiftType: getVal('shiftType'),
            controller1: controller1Details.label,
            controller1Id: controller1Details.uid,
            controller1Uid: controller1Details.uid,
            controller1Email: (controller1Details.email || '').toLowerCase(),
            controller2: controller2Details.label,
            controller2Id: controller2Details.uid,
            controller2Uid: controller2Details.uid,
            controller2Email: (controller2Details.email || '').toLowerCase(),
            startingDestination: getVal('startingDestination'),
            endingDestination: getVal('endingDestination'),
            totalTrucks: getVal('totalTrucks'),
            totalLoads: getVal('totalLoads'),
            loadsDelivered: getVal('loadsDelivered'),
            pendingDeliveries: getVal('pendingDeliveries'),
            shiftPerformance: getVal('shiftPerformance'),
            keyHighlights: getVal('keyHighlights'),
            truckUpdates,
            breakdowns,
            phoneCalls,
            investigations,
            communicationLog,
            outstandingIssues: getVal('outstandingIssues'),
            incomingInfo: getVal('incomingInfo'),
            reviewer1: reviewer1Details.email || reviewer1Details.uid,
            reviewer1Id: reviewer1Details.uid,
            reviewer1Name: reviewer1Details.label,
            reviewer2: reviewer2Details.email || reviewer2Details.uid,
            reviewer2Id: reviewer2Details.uid,
            reviewer2Name: reviewer2Details.label,
          };
        }

        setFormData(data) {
          const setVal = (id, val = '') => {
            const el = document.getElementById(id);
            if (el) el.value = val;
          };
          setVal('reportDate', data.reportDate || '');
          setVal('shiftType', data.shiftType || '');
          setVal('startingDestination', data.startingDestination || '');
          setVal('endingDestination', data.endingDestination || '');
          setVal('totalTrucks', data.totalTrucks || '');
          setVal('totalLoads', data.totalLoads || '');
          setVal('loadsDelivered', data.loadsDelivered || '');
          setVal('pendingDeliveries', data.pendingDeliveries || '');
          setVal('shiftPerformance', data.shiftPerformance || '');
          setVal('keyHighlights', data.keyHighlights || '');
          setVal('outstandingIssues', data.outstandingIssues || '');
          setVal('incomingInfo', data.incomingInfo || '');

          const reviewerEntries = Array.isArray(data.reviewers) ? data.reviewers : [];
          const primaryReviewer =
            reviewerEntries.find((r) => r.role === 'primary') ||
            reviewerEntries.find((r) => r.required);
          const secondaryReviewer = reviewerEntries.find((r) => r.role === 'secondary');

          setSelectPreference('controller1', {
            uid: data.controller1Id || '',
            email: data.controller1Email || '',
            label: data.controller1 || '',
          });

          setSelectPreference('controller2', {
            uid: data.controller2Id || '',
            email: data.controller2Email || '',
            label: data.controller2 || '',
          });

          setSelectPreference('reviewer1', {
            uid: data.reviewer1Id || primaryReviewer?.uid || '',
            email: data.reviewer1 || primaryReviewer?.email || '',
            label: data.reviewer1Name || primaryReviewer?.name || '',
          });

          setSelectPreference('reviewer2', {
            uid: data.reviewer2Id || secondaryReviewer?.uid || '',
            email: data.reviewer2 || secondaryReviewer?.email || '',
            label: data.reviewer2Name || secondaryReviewer?.name || '',
          });

          // Clear dynamic sections
          this.containers.truckUpdates.innerHTML = '';
          this.containers.breakdowns.innerHTML = '';
          this.containers.phoneCalls.innerHTML = '';
          this.containers.investigations.innerHTML = '';
          this.containers.communicationLog.innerHTML = '';

          // Add data
          (data.truckUpdates || []).forEach((t) => this.addTruckUpdate(t));
          (data.breakdowns || []).forEach((b) => this.addBreakdown(b));
          (data.phoneCalls || []).forEach((p) => this.addPhoneCall(p));
          (data.investigations || []).forEach((i) => this.addInvestigation(i));
          (data.communicationLog || []).forEach((c) => this.addCommunication(c));
        }
      }

      // Initialize form service
      const formService = new FormService();

      if (generatePdfBtn) {
        const pdfIcon = generatePdfBtn.querySelector('.material-symbols-outlined');
        const originalIcon = pdfIcon ? pdfIcon.textContent : null;
        generatePdfBtn.addEventListener('click', async () => {
          if (!currentReportId || !currentReportData) {
            showMessage('Report must be loaded before generating a PDF.', 'error');
            return;
          }
          try {
            generatePdfBtn.disabled = true;
            generatePdfBtn.classList.add('opacity-70', 'cursor-wait');
            if (pdfIcon && originalIcon) {
              pdfIcon.textContent = 'downloading';
            }
            showMessage('Generating PDF...', 'info');
            await generatePdf(currentReportData, { autoDownload: true });
            currentReportData.pdfGenerated = true;
            if (typeof enhancedReportService.markPdfGenerated === 'function') {
              await enhancedReportService.markPdfGenerated(currentReportId);
            }
            showMessage('PDF generated successfully. Check your downloads folder.', 'success');
          } catch (error) {
            console.error('Error generating PDF:', error);
            showMessage('Failed to generate PDF: ' + (error.message || error), 'error');
          } finally {
            generatePdfBtn.disabled = false;
            generatePdfBtn.classList.remove('opacity-70', 'cursor-wait');
            if (pdfIcon && originalIcon) {
              pdfIcon.textContent = originalIcon;
            }
          }
        });
      }

      // Authentication and form handling
      let currentUser = null;
      let currentUserRole = ROLE_CONTROLLER;
      let roleResolved = false;
      let pendingDashboardRedirect = false;
      const dashboardLinks = document.querySelectorAll('[data-dashboard-link]');
      const backToDashboardLink = document.getElementById('backToDashboardLink');

      const getDashboardUrl = () =>
        currentUserRole === ROLE_MANAGER ? 'dashboard-manager.html' : 'dashboard-controller.html';

      function updateDashboardLinks() {
        const destination = getDashboardUrl();
        dashboardLinks.forEach((link) => {
          if (link) {
            link.setAttribute('href', destination);
          }
        });
      }

      function redirectToDashboard() {
        if (!roleResolved) {
          pendingDashboardRedirect = true;
          showMessage('Preparing your dashboard...', 'info');
          return;
        }
        pendingDashboardRedirect = false;
        window.location.href = getDashboardUrl();
      }

      if (backToDashboardLink) {
        backToDashboardLink.addEventListener('click', (event) => {
          if (!roleResolved) {
            event.preventDefault();
            redirectToDashboard();
            return;
          }

          if (
            event.defaultPrevented ||
            event.button === 1 ||
            event.metaKey ||
            event.ctrlKey ||
            event.shiftKey
          ) {
            return;
          }

          event.preventDefault();
          redirectToDashboard();
        });
      }

      // Use Authentication Guard
      (async () => {
        try {
          const authResult = await userService.initializeAuthGuard();

          if (authResult.authenticated) {
            currentUser = authResult.user;
            currentUserRole = authResult.role;

            updateDashboardLinks();
            roleResolved = true;

            // Check if we're in view mode (reportId in URL)
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('reportId');

            if (generatePdfBtn) {
              generatePdfBtn.style.display = 'none';
              generatePdfBtn.disabled = true;
            }

            if (reportId) {
              await loadReportForView(reportId);
            } else {
              currentReportId = null;
              currentReportData = null;
              // Only enable buttons if authenticated and not in view mode
              const sendForReviewBtn = document.getElementById('sendForReviewBtn');
              const saveAsDraftBtn = document.getElementById('saveAsDraftBtn');

              if (sendForReviewBtn) {
                sendForReviewBtn.disabled = false;
              }
              if (saveAsDraftBtn) {
                saveAsDraftBtn.disabled = false;
              }
            }

            if (pendingDashboardRedirect) {
              redirectToDashboard();
              return;
            }

            const userAvatar = document.querySelector('.h-10.w-10.rounded-full');
            if (userAvatar) {
              const displayName =
                authResult.user.displayName || authResult.user.email.split('@')[0];
              userAvatar.style.backgroundImage = `url("https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=137fec&color=fff&size=40")`;
            }
          } else {
            // Auth guard will handle the redirect
          }
        } catch (error) {
          console.error('âŒ Report Form: Error during authentication:', error);
        }
      })();

      // Save as draft handler

      document.getElementById('saveAsDraftBtn').addEventListener('click', async () => {
        await saveReport('draft');
      });

      // Send for review handler

      document.getElementById('sendForReviewBtn').addEventListener('click', async () => {
        await saveReport('under_review');
      });

      // Common save function

      async function saveReport(status) {
        try {
          if (!currentUser) {
            showMessage('You must be signed in before saving this report.', 'error');

            return;
          }

          const data = formService.getFormData();

          const isDraft = status === 'draft';

          const isReview = status === 'under_review';

          if (
            typeof data.controller1Id === 'string' &&
            typeof data.controller2Id === 'string' &&
            data.controller1Id &&
            data.controller2Id &&
            data.controller1Id.trim() &&
            data.controller2Id.trim() &&
            data.controller1Id.trim().toLowerCase() === data.controller2Id.trim().toLowerCase()
          ) {
            showMessage('The two on-duty controllers must be different people.', 'error');
            return;
          }

          if (isDraft) {
            if (!data.reportDate && !data.shiftType && !data.controller1) {
              showMessage('Please fill in at least the basic report information.', 'error');

              return;
            }
          }

          if (isReview) {
            if (!data.reportDate || !data.shiftType || !data.controller1 || !data.controller2) {
              showMessage(
                'Please complete required fields: Date, Shift, and Controllers.',
                'error'
              );

              return;
            }

            const primaryReviewerSelect = document.getElementById('reviewer1');

            const secondaryReviewerSelect = document.getElementById('reviewer2');

            const reviewerEntries = [];

            const collectReviewer = (select, { required = false, role = ROLE_REVIEWER } = {}) => {
              if (!select) return;

              const selectedOption = select.selectedOptions && select.selectedOptions[0];

              if (!selectedOption) return;

              const uid = (selectedOption.value || '').trim();

              if (!uid) return;

              const email = (selectedOption.dataset.email || '').trim();

              const name = selectedOption.text ? selectedOption.text.trim() : email || uid;

              reviewerEntries.push({
                uid,

                email: email.toLowerCase(),

                name,

                required,

                role,

                status: 'pending',

                approved: false,

                rejected: false,
              });
            };

            collectReviewer(primaryReviewerSelect, { required: true, role: 'primary' });

            collectReviewer(secondaryReviewerSelect, { required: false, role: 'secondary' });

            if (reviewerEntries.length === 0) {
              showMessage(
                'Please assign at least one reviewer before sending for review.',
                'error'
              );

              return;
            }

            data.reviewers = reviewerEntries;
          }

          const clientTimestampIso = nowIso();

          const additionalFields = {
            updatedAtClientIso: clientTimestampIso,
          };

          if (isReview) {
            additionalFields.submittedAtClientIso = clientTimestampIso;
            additionalFields.reviewRequestedAtClientIso = clientTimestampIso;
          }

          const result = await enhancedReportService.createReport(data, {
            status,
            additionalFields,
            clientTimestampIso,
          });

          if (result.success) {
            if (isDraft) {
              showMessage('Report saved as draft successfully!', 'success');
            } else if (isReview) {
              const chatLink = document.createElement('a');
              chatLink.href = `messages.html?conv=${encodeURIComponent(result.reportId)}`;
              chatLink.className =
                'inline-flex items-center gap-1 rounded-full border border-blue-600 px-3 py-1 text-xs font-semibold text-blue-600 transition-colors hover:bg-blue-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2';
              chatLink.textContent = 'View chat';
              chatLink.setAttribute('aria-label', 'View report conversation in messages');

              showMessage(
                'Report has been successfully submitted for review. The reviewers have been notified.',
                'success',
                [chatLink]
              );
            } else {
              showMessage('Report saved successfully.', 'success');
            }

            formService.setFormData({});
          } else {
            throw new Error(result.error);
          }
        } catch (error) {
          console.error('Error saving report:', error);

          showMessage('Error saving report: ' + (error.message || error), 'error');
        }
      }

      // Message display function
      function showMessage(message, type = 'info', actionElements = []) {
        const messageBox = document.getElementById('message-box');
        if (!messageBox) return;

        messageBox.style.display = 'block';
        messageBox.innerHTML = '';

        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        messageBox.appendChild(messageSpan);

        if (Array.isArray(actionElements) && actionElements.length) {
          const actionsWrapper = document.createElement('span');
          actionsWrapper.className =
            'ml-3 inline-flex flex-wrap items-center gap-2 text-sm font-medium leading-tight';

          actionElements.forEach((element) => {
            if (element && element.nodeType === Node.ELEMENT_NODE) {
              actionsWrapper.appendChild(element);
            }
          });

          if (actionsWrapper.childElementCount > 0) {
            messageBox.appendChild(actionsWrapper);
          }
        }

        const classes = {
          success: 'bg-green-100 text-green-700 border border-green-200',
          error: 'bg-red-100 text-red-700 border border-red-200',
          info: 'bg-blue-100 text-blue-700 border border-blue-200',
        };
        messageBox.className = `p-3 rounded-xl mb-4 font-semibold ${classes[type] || classes.info}`;

        if (messageBox.dataset.timeoutId) {
          clearTimeout(Number(messageBox.dataset.timeoutId));
        }

        const timeoutId = setTimeout(() => {
          messageBox.style.display = 'none';
          delete messageBox.dataset.timeoutId;
        }, 5000);
        messageBox.dataset.timeoutId = String(timeoutId);
      }

      // Load report for view mode
      async function loadReportForView(reportId) {
        try {
          showMessage('Loading report...', 'info');

          // Fetch report from Firestore
          const { doc, getDoc } = await import(
            'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js'
          );
          const { db } = await import('./firebase-config.js');

          const reportDoc = await getDoc(doc(db, 'shiftReports', reportId));

          if (!reportDoc.exists()) {
            showMessage('Report not found', 'error');
            if (generatePdfBtn) {
              generatePdfBtn.style.display = 'none';
              generatePdfBtn.disabled = true;
            }
            return;
          }

          const reportData = reportDoc.data();
          reportData.id = reportId;
          currentReportId = reportId;
          currentReportData = { ...reportData };
          if (generatePdfBtn) {
            generatePdfBtn.style.display = 'flex';
            generatePdfBtn.disabled = false;
          }

          // Set view mode
          window.isViewMode = true;

          // Disable form for view mode
          disableFormForView();

          // Populate form with report data
          formService.setFormData(reportData);

          // Update page title
          document.title = `View Report - ${reportData.reportDate || 'Unknown Date'} - Thinkers Afrika`;

          showMessage('Report loaded successfully', 'success');
        } catch (error) {
          console.error('Error loading report:', error);
          showMessage('Error loading report: ' + error.message, 'error');
          currentReportId = null;
          currentReportData = null;
          if (generatePdfBtn) {
            generatePdfBtn.style.display = 'none';
            generatePdfBtn.disabled = true;
          }
        }
      }

      // Disable form for view mode
      function disableFormForView() {
        // Disable all form inputs
        const inputs = document.querySelectorAll('input, select, textarea, button');
        inputs.forEach((input) => {
          if (
            input.id !== 'sendForReviewBtn' &&
            input.id !== 'generatePdfBtn' &&
            input.id !== 'saveAsDraftBtn'
          ) {
            input.disabled = true;
          }
        });

        // Hide action buttons
        const sendForReviewBtn = document.getElementById('sendForReviewBtn');
        const saveAsDraftBtn = document.getElementById('saveAsDraftBtn');

        if (sendForReviewBtn) {
          sendForReviewBtn.style.display = 'none';
        }
        if (saveAsDraftBtn) {
          saveAsDraftBtn.style.display = 'none';
        }

        // Update page header
        const pageTitle = document.querySelector('h1');
        if (pageTitle) {
          pageTitle.textContent = 'View Shift Report';
        }

        const pageDescription = document.querySelector('p');
        if (pageDescription) {
          pageDescription.textContent = 'Viewing report in read-only mode.';
        }
      }

      // Make form service available globally
      window.FormService = formService;
    </script>
  </body>
</html>
